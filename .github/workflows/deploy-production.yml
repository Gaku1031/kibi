name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-1
  COMPREHEND_CLASSIFIER_ARN: arn:aws:comprehend:ap-northeast-1:223708988018:document-classifier/kibi-emotion-classifier
  ENDPOINT_NAME: kibi-emotion-endpoint

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            infrastructure/package-lock.json
            backend/package-lock.json

      - name: Check and create Comprehend endpoint
        id: comprehend
        run: |
          # 既存エンドポイントを取得（エラーを無視）
          set +e
          ENDPOINT_INFO=$(aws comprehend list-endpoints --output json)
          set -e

          # エンドポイントARNで検索（EndpointNameがnullの場合があるため）
          ENDPOINT_ARN=$(echo "$ENDPOINT_INFO" | jq -r ".EndpointPropertiesList[] | select(.EndpointArn | contains(\"${ENDPOINT_NAME}\")) | .EndpointArn")

          if [ -n "$ENDPOINT_ARN" ]; then
            echo "Endpoint found: $ENDPOINT_ARN"

            # ステータス確認
            STATUS=$(aws comprehend describe-endpoint \
              --endpoint-arn "$ENDPOINT_ARN" \
              --query 'EndpointProperties.Status' \
              --output text)

            echo "Current status: $STATUS"

            # IN_SERVICE以外の場合は待機
            if [ "$STATUS" != "IN_SERVICE" ]; then
              echo "Waiting for endpoint to become IN_SERVICE..."
              for i in {1..90}; do
                sleep 20
                STATUS=$(aws comprehend describe-endpoint \
                  --endpoint-arn "$ENDPOINT_ARN" \
                  --query 'EndpointProperties.Status' \
                  --output text)

                echo "Status check $i/90: $STATUS"

                if [ "$STATUS" = "IN_SERVICE" ]; then
                  echo "Endpoint is ready!"
                  break
                elif [ "$STATUS" = "FAILED" ]; then
                  echo "Error: Endpoint is in FAILED state"
                  exit 1
                fi
              done
            fi
          else
            echo "No existing endpoint found. Creating new endpoint..."

            # エンドポイント作成（エラーハンドリング）
            set +e
            CREATE_OUTPUT=$(aws comprehend create-endpoint \
              --endpoint-name "${ENDPOINT_NAME}" \
              --model-arn "${COMPREHEND_CLASSIFIER_ARN}" \
              --desired-inference-units 1 \
              --output json 2>&1)
            CREATE_EXIT_CODE=$?
            set -e

            if [ $CREATE_EXIT_CODE -ne 0 ]; then
              # 既に存在する場合は取得
              if echo "$CREATE_OUTPUT" | grep -q "ResourceInUseException"; then
                echo "Endpoint already exists (race condition). Fetching existing endpoint..."
                ENDPOINT_ARN=$(echo "$ENDPOINT_INFO" | jq -r ".EndpointPropertiesList[] | select(.EndpointArn | contains(\"${ENDPOINT_NAME}\")) | .EndpointArn")
                if [ -z "$ENDPOINT_ARN" ] || [ "$ENDPOINT_ARN" = "null" ]; then
                  # リスト再取得
                  echo "Re-fetching endpoint list..."
                  ENDPOINT_INFO=$(aws comprehend list-endpoints --output json)
                  ENDPOINT_ARN=$(echo "$ENDPOINT_INFO" | jq -r ".EndpointPropertiesList[] | select(.EndpointArn | contains(\"${ENDPOINT_NAME}\")) | .EndpointArn")

                  # まだ見つからない場合はエラー
                  if [ -z "$ENDPOINT_ARN" ] || [ "$ENDPOINT_ARN" = "null" ]; then
                    echo "Error: Endpoint exists but could not retrieve ARN"
                    echo "Available endpoints:"
                    echo "$ENDPOINT_INFO" | jq '.EndpointPropertiesList[] | {EndpointName, EndpointArn}'
                    exit 1
                  fi
                fi
              else
                echo "Error creating endpoint: $CREATE_OUTPUT"
                exit 1
              fi
            else
              ENDPOINT_ARN=$(echo "$CREATE_OUTPUT" | jq -r '.EndpointArn')
              echo "Created new endpoint: $ENDPOINT_ARN"
            fi

            # エンドポイントがIN_SERVICEになるまで待機
            echo "Waiting for endpoint to become available..."
            for i in {1..90}; do
              sleep 20
              STATUS=$(aws comprehend describe-endpoint \
                --endpoint-arn "$ENDPOINT_ARN" \
                --query 'EndpointProperties.Status' \
                --output text)

              echo "Status check $i/90: $STATUS"

              if [ "$STATUS" = "IN_SERVICE" ]; then
                echo "Endpoint is ready!"
                break
              elif [ "$STATUS" = "FAILED" ]; then
                echo "Error: Endpoint creation failed"
                exit 1
              fi
            done
          fi

          # 環境変数として出力
          echo "endpoint_arn=$ENDPOINT_ARN" >> $GITHUB_OUTPUT

      - name: Bootstrap CDK environment
        working-directory: infrastructure
        run: |
          npm ci
          echo "=== Checking existing CDK Bootstrap stack ==="

          # 既存のCDKToolkitスタックが古い場合は削除
          set +e
          STACK_EXISTS=$(aws cloudformation describe-stacks \
            --stack-name CDKToolkit \
            --region ${{ env.AWS_REGION }} 2>&1)
          STACK_EXIT_CODE=$?
          set -e

          if [ $STACK_EXIT_CODE -eq 0 ]; then
            echo "Found existing CDKToolkit stack"

            # SSMパラメータが存在するか確認
            set +e
            aws ssm get-parameter \
              --name /cdk-bootstrap/hnb659fds/version \
              --region ${{ env.AWS_REGION }} >/dev/null 2>&1
            SSM_EXIT_CODE=$?
            set -e

            if [ $SSM_EXIT_CODE -ne 0 ]; then
              echo "Old bootstrap stack detected (missing SSM parameters)"
              echo "Deleting old CDKToolkit stack..."

              aws cloudformation delete-stack \
                --stack-name CDKToolkit \
                --region ${{ env.AWS_REGION }}

              echo "Waiting for stack deletion to complete..."
              aws cloudformation wait stack-delete-complete \
                --stack-name CDKToolkit \
                --region ${{ env.AWS_REGION }}

              echo "Old stack deleted successfully"
            else
              echo "Bootstrap stack is up-to-date"
            fi
          else
            echo "No existing CDKToolkit stack found"
          fi

          echo "=== Starting CDK Bootstrap ==="
          npx cdk bootstrap aws://223708988018/${{ env.AWS_REGION }} --verbose

          echo "=== Verifying Bootstrap ==="
          aws cloudformation describe-stacks \
            --stack-name CDKToolkit \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text

          aws ssm get-parameter \
            --name /cdk-bootstrap/hnb659fds/version \
            --region ${{ env.AWS_REGION }} \
            --query 'Parameter.Value' \
            --output text

          echo "=== Bootstrap completed successfully ==="

      - name: Deploy infrastructure
        working-directory: infrastructure
        env:
          COMPREHEND_ENDPOINT_ARN: ${{ steps.comprehend.outputs.endpoint_arn }}
        run: |
          npm run deploy -- --require-approval never

      - name: Get API URL
        id: api
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name KibiStack \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiURL`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"

      - name: Update Amplify environment variables
        run: |
          # Amplifyアプリの取得（名前で検索）
          APP_ID=$(aws amplify list-apps \
            --query "apps[?name=='kibi-frontend'].appId" \
            --output text)

          if [ -n "$APP_ID" ]; then
            echo "Updating Amplify app: $APP_ID"

            # 環境変数の更新
            aws amplify update-app \
              --app-id $APP_ID \
              --environment-variables NEXT_PUBLIC_API_URL=${{ steps.api.outputs.api_url }}

            # 再ビルドをトリガー
            BRANCH_NAME="main"
            JOB_ID=$(aws amplify start-job \
              --app-id $APP_ID \
              --branch-name $BRANCH_NAME \
              --job-type RELEASE \
              --query 'jobSummary.jobId' \
              --output text)

            echo "Triggered Amplify build: $JOB_ID"
          else
            echo "Amplify app not found. Please create it manually using AMPLIFY_SETUP.md"
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Comprehend Endpoint**: ${{ steps.comprehend.outputs.endpoint_arn }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${{ steps.api.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Comprehend endpoint costs ~$40/month while running." >> $GITHUB_STEP_SUMMARY
