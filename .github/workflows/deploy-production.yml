name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  AWS_REGION: ap-northeast-1

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            infrastructure/package-lock.json
            backend/package-lock.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU for ARM64 builds
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Bootstrap CDK environment
        working-directory: infrastructure
        run: |
          npm ci
          echo "=== Checking existing CDK Bootstrap stack ==="

          # 既存のCDKToolkitスタックが古い場合は削除
          set +e
          STACK_EXISTS=$(aws cloudformation describe-stacks \
            --stack-name CDKToolkit \
            --region ${{ env.AWS_REGION }} 2>&1)
          STACK_EXIT_CODE=$?
          set -e

          if [ $STACK_EXIT_CODE -eq 0 ]; then
            echo "Found existing CDKToolkit stack"

            # SSMパラメータが存在するか確認
            set +e
            aws ssm get-parameter \
              --name /cdk-bootstrap/hnb659fds/version \
              --region ${{ env.AWS_REGION }} >/dev/null 2>&1
            SSM_EXIT_CODE=$?
            set -e

            if [ $SSM_EXIT_CODE -ne 0 ]; then
              echo "Old bootstrap stack detected (missing SSM parameters)"
              echo "Deleting old CDKToolkit stack..."

              aws cloudformation delete-stack \
                --stack-name CDKToolkit \
                --region ${{ env.AWS_REGION }}

              echo "Waiting for stack deletion to complete..."
              aws cloudformation wait stack-delete-complete \
                --stack-name CDKToolkit \
                --region ${{ env.AWS_REGION }}

              echo "Old stack deleted successfully"
            else
              echo "Bootstrap stack is up-to-date"
            fi
          else
            echo "No existing CDKToolkit stack found"
          fi

          echo "=== Starting CDK Bootstrap ==="
          npx cdk bootstrap aws://223708988018/${{ env.AWS_REGION }} --verbose

          echo "=== Verifying Bootstrap ==="
          aws cloudformation describe-stacks \
            --stack-name CDKToolkit \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text

          aws ssm get-parameter \
            --name /cdk-bootstrap/hnb659fds/version \
            --region ${{ env.AWS_REGION }} \
            --query 'Parameter.Value' \
            --output text

          echo "=== Bootstrap completed successfully ==="

      - name: Deploy infrastructure
        working-directory: infrastructure
        run: |
          npm run deploy -- --require-approval never

      - name: Get API URL
        id: api
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name kibi-prod \
            --query 'Stacks[0].Outputs[?OutputKey==`ApiURL`].OutputValue' \
            --output text)
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "API URL: $API_URL"

      - name: Update Amplify environment variables
        run: |
          # Amplifyアプリの取得（名前で検索）
          APP_ID=$(aws amplify list-apps \
            --query "apps[?name=='kibi'].appId" \
            --output text)

          if [ -n "$APP_ID" ]; then
            echo "Updating Amplify app: $APP_ID"

            # 環境変数の更新（モノレポ設定とAPI URLの両方を設定）
            # API URLから末尾のスラッシュを削除
            API_URL="${{ steps.api.outputs.api_url }}"
            API_URL="${API_URL%/}"

            aws amplify update-app \
              --app-id $APP_ID \
              --environment-variables "AMPLIFY_MONOREPO_APP_ROOT=front,NEXT_PUBLIC_API_URL=${API_URL}"

            echo "✓ Environment variables updated"
            echo "Note: Rebuild Amplify manually from the console if needed"
          else
            echo "Amplify app not found. Please create it manually using AMPLIFY_SETUP.md"
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: ${{ steps.api.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Using async Comprehend jobs (no endpoint, pay-per-use)." >> $GITHUB_STEP_SUMMARY
